name: CMake on multiple platforms

on:
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: build (${{ contains(matrix.os, 'ubuntu') && 'linux' || contains(matrix.os, 'macos') && 'macos' || 'windows' }}-${{ contains(matrix.os, '-arm') && 'arm64' || contains(matrix.os, 'macos-26') && 'arm64' || contains(matrix.os, '-intel') && 'x86_64' || 'x86_64' }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- x86_64 Builds ---
          - os: ubuntu-latest # x86_64
            build_type: Release
            c_compiler: gcc
            cpp_compiler: g++
            artifact_name: chisel-ubuntu-x86_64-gcc
            binary_path: bin/Release/chisel

          - os: ubuntu-latest # x86_64
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++
            artifact_name: chisel-ubuntu-x86_64-clang
            binary_path: bin/Release/chisel

          - os: macos-15-intel # x86_64
            build_type: Release
            c_compiler: gcc-12
            cpp_compiler: g++-12
            artifact_name: chisel-macos-x86_64
            binary_path: bin/Release/chisel

          - os: windows-latest # x86_64
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            artifact_name: chisel-windows-x86_64
            binary_path: bin/Release/chisel.exe

          # --- ARM64 Builds ---
          - os: ubuntu-24.04-arm # Linux ARM64
            build_type: Release
            c_compiler: gcc
            cpp_compiler: g++
            artifact_name: chisel-linux-arm64-gcc
            binary_path: bin/Release/chisel

          - os: macos-26 # macOS ARM64 (M1 Public Preview)
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++
            artifact_name: chisel-macos-arm64
            binary_path: bin/Release/chisel

          - os: windows-11-arm # Windows ARM64
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            artifact_name: chisel-windows-arm64
            binary_path: bin/Release/chisel.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          lfs: true

      - name: Setup Git LFS
        run: |
          git lfs install
          git lfs pull

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config \
            autoconf automake libtool m4 nasm yasm

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install autoconf automake libtool nasm yasm
          # install GCC 12 for Intel builds
          if [[ "$(uname -m)" == "x86_64" ]]; then
            brew install gcc@12
          fi

      - name: Set build output directory
        id: strings
        shell: bash
        run: echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      - name: Configure CMake
        run: >
          cmake -B ${{ steps.strings.outputs.build-output-dir }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DBUILD_TESTING=OFF
          -S ${{ github.workspace }}

      - name: Build
        run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ github.workspace }}/${{ matrix.binary_path }}