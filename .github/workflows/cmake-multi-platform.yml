name: Multi-platform build

on:
  push:
    branches: [ "main", "development" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.platform_name }}
    runs-on: ${{ matrix.runs_on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: ubuntu-gcc
            runs_on: ubuntu-latest
            platform_name: "Linux x64 (GCC)"
            asset_name: "linux-x64-gcc"
            build_type: Release
            c_compiler: gcc
            cpp_compiler: g++
            binary_path: bin/chisel

          - id: ubuntu-clang
            runs_on: ubuntu-latest
            platform_name: "Linux x64 (Clang)"
            asset_name: "linux-x64-clang"
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++
            binary_path: bin/chisel

          - id: ubuntu-arm
            runs_on: ubuntu-24.04-arm
            platform_name: "Linux ARM64"
            asset_name: "linux-arm64-gcc"
            build_type: Release
            c_compiler: gcc
            cpp_compiler: g++
            binary_path: bin/chisel

          - id: macos-intel
            runs_on: macos-13
            platform_name: "macOS Intel"
            asset_name: "macos-x64"
            build_type: Release
            c_compiler: gcc-12
            cpp_compiler: g++-12
            binary_path: bin/chisel

          - id: macos-arm
            runs_on: macos-latest
            platform_name: "macOS Apple Silicon"
            asset_name: "macos-arm64"
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++
            binary_path: bin/chisel

          - id: windows-x86
            runs_on: windows-latest
            platform_name: "Windows x86"
            asset_name: "windows-x86"
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            arch: x86
            binary_path: bin/Release/chisel

          - id: windows-arm
            runs_on: windows-latest
            platform_name: "Windows ARM64"
            asset_name: "windows-arm64"
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            arch: arm64
            binary_path: bin/Release/chisel

          - id: windows-msvc
            runs_on: windows-latest
            platform_name: "Windows x64"
            asset_name: "windows-x64"
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl
            arch: x64
            binary_path: bin/Release/chisel

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- Install Dependencies ---
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config autoconf automake libtool m4 nasm yasm ninja-build

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install pkg-config autoconf automake libtool nasm yasm ninja

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install nasm yasm ninja

      # --- Versioning ---
      - name: Determine Version
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"

      # --- Build ---
      - name: Configure CMake
        run: >
          cmake -B bin
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -S ${{ github.workspace }}
          ${{ (runner.os == 'Windows' && format('-A {0}', matrix.arch)) || '' }}

      - name: Build
        run: cmake --build bin --config ${{ matrix.build_type }} --parallel

      - name: Test
        working-directory: bin
        run: ctest -C ${{ matrix.build_type }} --output-on-failure

      # --- Verification ---
      - name: Verify static linking (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Checking dependencies for Linux..."
          ldd bin/chisel
          if ldd bin/chisel | grep -E "libarchive|libpng|libjpeg|libflac|libz|libbz2|liblzma|libzstd"; then
            echo "Error: Forbidden dynamic libraries found!"
            exit 1
          else
            echo "OK: No forbidden dynamic libraries found."
          fi

      - name: Verify static linking (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Checking dependencies for macOS..."
          otool -L bin/chisel
          if otool -L bin/chisel | grep -E "libarchive|libpng|libjpeg|libflac|libz\.|libbz2|liblzma|libzstd"; then
            echo "Error: Forbidden dynamic libraries found!"
            exit 1
          else
            echo "OK: No forbidden dynamic libraries found."
          fi

      - name: Verify static linking (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          echo "Checking dependencies for Windows..."
          dumpbin /dependents "${{ matrix.binary_path }}.exe"
          dumpbin /dependents "${{ matrix.binary_path }}.exe" | findstr /i "archive.dll png.dll jpeg.dll flac.dll zlib.dll bzip2.dll lzma.dll zstd.dll" > nul
          if %errorlevel% equ 0 (
            echo Error: Forbidden dynamic libraries found!
            exit 1
          ) else (
            echo OK: No forbidden dynamic libraries found.
          )

      # --- Rename & Upload ---
      - name: Rename Binary
        shell: bash
        run: |
          EXT=""
          SRC="${{ matrix.binary_path }}"
          
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            EXT=".exe"
            # Assicurati di aggiungere .exe se non c'Ã¨ nella variabile matrix
            if [[ "$SRC" != *".exe" ]]; then SRC="$SRC.exe"; fi
          fi
          
          DEST="chisel-${{ matrix.asset_name }}-${{ env.VERSION }}$EXT"
          
          echo "Renaming $SRC to $DEST"
          mv "$SRC" "$DEST"
          
          echo "ARTIFACT_PATH=$DEST" >> $GITHUB_ENV

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.asset_name }}
          path: ${{ env.ARTIFACT_PATH }}
          if-no-files-found: error

  #  verify-static-linking-freebsd:
  #    name: verify-static-linking (freebsd-${{ matrix.arch }})
  #    needs: build-freebsd
  #    runs-on: ubuntu-latest
  #    strategy:
  #      fail-fast: false
  #      matrix:
  #        include:
  #          - id: freebsd-x86
  #            arch: amd64
  #          - id: freebsd-arm
  #            arch: arm64
  #    env:
  #      BIN_DIR: bin
  #      FORBIDDEN_LIBS: "jpeg|png|flac|archive|zlib|jxl|tiff|qpdf|webp|wavpack|sqlite|magic|mseed|ebml|matroska|mkclean|zopfli|ape|gif|mac|flexigif"
  #    steps:
  #      - name: Download binary artifact
  #        uses: actions/download-artifact@v4
  #        with:
  #          name: chisel-${{ matrix.id }}
  #          path: ${{ env.BIN_DIR }}
  #      - name: Verify FreeBSD (ldd)
  #        uses: vmactions/freebsd-vm@v1
  #        with:
  #          arch: ${{ matrix.arch }}
  #          usesh: true
  #          run: |
  #            echo "Checking dependencies for FreeBSD..."
  #            chmod +x ${{ env.BIN_DIR }}/chisel
  #            ldd ${{ env.BIN_DIR }}/chisel
  #            echo "Analyzing dependencies..."
  #            if ldd ${{ env.BIN_DIR }}/chisel | grep -E "(${FORBIDDEN_LIBS})"; then
  #              echo "Error: Forbidden dynamic libraries found!"
  #              exit 1
  #            else
  #              echo "OK: No forbidden dynamic libraries found."
  #            fi

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/tags/development-latest'

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Display Downloaded Files
        run: ls -R artifacts

      - name: Delete old release (dev only)
        if: github.ref == 'refs/tags/development-latest'
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: development-latest
          github_token: ${{ secrets.GITHUB_TOKEN }}
          delete_release: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref == 'refs/tags/development-latest' && 'Development Build' || github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: artifacts/*
          draft: false
          prerelease: ${{ github.ref == 'refs/tags/development-latest' || contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
          generate_release_notes: true